<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiation Test - Neon Serpents</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* ========== BASE RESET & FONTS ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: linear-gradient(135deg, #0a0015 0%, #1a0033 50%, #000000 100%);
            color: #00ffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== SCANLINE OVERLAY ========== */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 255, 0.03),
                rgba(0, 255, 255, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* ========== HEADER ========== */
        header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #ff00ff;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
        }

        .breadcrumb {
            color: #00ffff;
            font-size: 1rem;
        }

        /* ========== MAIN CONTAINER ========== */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 3rem;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }

        /* ========== LEFT COLUMN: INSTRUCTIONS ========== */
        .instructions {
            background: rgba(30, 30, 35, 0.8);
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 2rem;
            height: fit-content;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .instructions h2 {
            color: #ff00ff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            text-shadow: 0 0 10px #ff00ff;
        }

        .instructions p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #00ffff;
        }

        .progress-section {
            margin-top: 2rem;
        }

        .progress-label {
            color: #ff00ff;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px #00ffff;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 5px #000;
        }

        /* ========== RIGHT COLUMN: QUESTION CARD ========== */
        .question-area {
            background: rgba(30, 30, 35, 0.9);
            border: 2px solid #ff00ff;
            border-radius: 12px;
            padding: 3rem;
            min-height: 500px;
            box-shadow: 0 0 30px rgba(255, 0, 102, 0.3);
            position: relative;
            perspective: 1000px;
        }

        .question-card {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-area.flipping .question-card {
            animation: cardFlip3D 0.6s ease-out;
        }

        @keyframes cardFlip3D {
            0% {
                transform: rotateY(0deg);
                opacity: 1;
            }
            50% {
                transform: rotateY(90deg);
                opacity: 0.3;
            }
            100% {
                transform: rotateY(0deg);
                opacity: 1;
            }
        }

        .question-card h3 {
            color: #ff00ff;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px #ff00ff;
        }

        .question-text {
            font-size: 1.2rem;
            color: #00ffff;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .choice-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .choice-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            text-align: left;
            transform-origin: center;
        }

        .choice-btn:focus {
            outline: 3px solid #ff00ff;
            outline-offset: 3px;
        }

        .choice-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: translateX(5px);
        }

        .choice-btn:active {
            animation: buttonPress 0.2s ease-out;
        }

        @keyframes buttonPress {
            0% { transform: scale(1) translateX(5px); }
            50% { transform: scale(0.95) translateX(5px); }
            100% { transform: scale(1) translateX(5px); }
        }

        .choice-btn.selected {
            background: rgba(255, 0, 102, 0.3);
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.6);
        }

        .flavor-text {
            font-size: 0.85rem;
            color: #999;
            font-style: italic;
            margin: 0;
            padding-left: 1.5rem;
            font-family: 'PT Mono', monospace;
            opacity: 0.8;
        }

        /* Puzzle specific styles */
        .puzzle-area {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .puzzle-icon {
            width: 80px;
            height: 80px;
            border: 2px solid #00ffff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
            user-select: none;
            transform-origin: center;
        }

        .puzzle-icon:focus {
            outline: 3px solid #ff00ff;
            outline-offset: 3px;
        }

        .puzzle-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }

        .puzzle-icon:active {
            animation: iconPress 0.3s ease-out;
        }

        @keyframes iconPress {
            0% { transform: scale(1.1); }
            50% { transform: scale(0.9) rotate(15deg); }
            100% { transform: scale(1.1); }
        }

        .puzzle-icon.active {
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.6);
        }

        /* ========== FOOTER BUTTONS ========== */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #ff00ff;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            z-index: 100;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            transform-origin: center;
        }

        .btn:focus {
            outline: 3px solid #ff00ff;
            outline-offset: 3px;
        }

        .btn:active:not(:disabled) {
            animation: btnPress 0.2s ease-out;
        }

        @keyframes btnPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.92); }
            100% { transform: scale(1); }
        }

        .btn-primary {
            color: #00ffff;
            border-color: #00ffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #00ffff;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }

        .btn-secondary {
            color: #999;
            border-color: #666;
        }

        .btn-secondary:hover {
            border-color: #00ffff;
            color: #00ffff;
        }

        .btn-danger {
            color: #ff0066;
            border-color: #ff0066;
        }

        .btn-danger:hover {
            background: #ff0066;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.6);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ========== MODAL (ROLE REVEAL) ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 30, 35, 0.95), rgba(15, 15, 20, 0.98));
            border: 3px solid #ff00ff;
            border-radius: 12px;
            padding: 3rem;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 0, 102, 0.8);
            animation: modalSlide 0.6s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-100px) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .role-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: glitchIcon 2s infinite;
        }

        @keyframes glitchIcon {
            0%, 90%, 92%, 94%, 96%, 98%, 100% {
                transform: translate(0);
                filter: hue-rotate(0deg);
            }
            91% {
                transform: translate(-3px, 3px);
                filter: hue-rotate(90deg);
            }
            93% {
                transform: translate(3px, -3px);
                filter: hue-rotate(180deg);
            }
            95% {
                transform: translate(-2px, -2px);
                filter: hue-rotate(270deg);
            }
            97% {
                transform: translate(2px, 2px);
                filter: hue-rotate(45deg);
            }
        }

        .role-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: #ff00ff;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        }

        .role-description {
            color: #00ffff;
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .hidden {
            display: none;
        }

        /* ========== PROCESSING SCREEN ========== */
        .processing-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .processing-screen.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .processing-content {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }

        .processing-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: #00ffff;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px #00ffff;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffff;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
            position: relative;
        }

        .processing-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 100%;
            width: 0%;
            animation: processingFill 1.2s ease-out forwards, gradientShift 1s linear infinite;
            box-shadow: 0 0 20px #00ffff;
        }

        @keyframes processingFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .terminal-logs {
            text-align: left;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            color: #00ffff;
            line-height: 1.8;
            opacity: 0;
            animation: fadeInLogs 0.3s ease-out 0.3s forwards;
        }

        @keyframes fadeInLogs {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .terminal-logs .log-line {
            opacity: 0;
            animation: logAppear 0.2s ease-out forwards;
        }

        .terminal-logs .log-line:nth-child(1) { animation-delay: 0.1s; }
        .terminal-logs .log-line:nth-child(2) { animation-delay: 0.3s; }
        .terminal-logs .log-line:nth-child(3) { animation-delay: 0.5s; }
        .terminal-logs .log-line:nth-child(4) { animation-delay: 0.7s; }
        .terminal-logs .log-line:nth-child(5) { animation-delay: 0.9s; }

        @keyframes logAppear {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            .puzzle-area {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .puzzle-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            footer {
                flex-direction: column;
                gap: 1rem;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .question-area {
                padding: 2rem 1.5rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">NEON SERPENTS</div>
        <div class="breadcrumb">Initiation Test</div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Column: Instructions & Progress -->
        <aside class="instructions">
            <h2>Test Protocol</h2>
            <p>You will face 4 situational challenges. Your choices determine your operational role.</p>
            <p>Answer honestly. There are no wrong answers, only assignments.</p>
            <p><strong>Roles:</strong></p>
            <ul style="font-size: 0.85rem; line-height: 1.6; color: #999; margin-left: 1.2rem;">
                <li>Ghost (Stealth)</li>
                <li>Venom (Data Manipulation)</li>
                <li>Prophet (Strategic Vision)</li>
            </ul>

            <div class="progress-section">
                <span class="progress-label">Progress</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <span class="progress-text" id="progressText">0 / 4</span>
                </div>
            </div>
        </aside>

        <!-- Right Column: Question Card -->
        <main class="question-area" id="questionArea">
            <div class="question-card" id="questionCard">
                <!-- Questions will be injected here by JS -->
            </div>
        </main>
    </div>

    <!-- Footer Buttons -->
    <footer>
        <button class="btn btn-secondary" id="skipBtn">Skip</button>
        <button class="btn btn-primary" id="submitBtn" disabled>Submit Answer</button>
        <button class="btn btn-danger" id="abortBtn">Abort Test</button>
    </footer>

    <!-- Role Reveal Modal -->
    <div class="modal" id="roleModal">
        <div class="modal-content">
            <div class="role-icon" id="roleIcon">üëÅÔ∏è</div>
            <h2 class="role-title" id="roleTitle">GHOST</h2>
            <p class="role-description" id="roleDescription">
                You move through shadows unseen. Your specialty is stealth, evasion, and silent extraction.
            </p>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="acceptRoleBtn">Accept Role</button>
                <button class="btn btn-secondary" id="retryBtn">Retry Test</button>
            </div>
        </div>
    </div>

    <!-- Processing Screen -->
    <div class="processing-screen" id="processingScreen">
        <div class="processing-content">
            <h2 class="processing-title">ANALYZING RESPONSES...</h2>
            <div class="processing-bar">
                <div class="processing-fill"></div>
            </div>
            <div class="terminal-logs">
                <div class="log-line">> Decrypting neural signatures...</div>
                <div class="log-line">> Cross-referencing behavioral patterns...</div>
                <div class="log-line">> Mapping operational profile...</div>
                <div class="log-line">> Calculating role assignment...</div>
                <div class="log-line">> Assignment complete. Initializing reveal...</div>
            </div>
        </div>
    </div>

    <script>
        // ========== QUESTIONS DATABASE ==========
        const questions = [
            {
                id: 1,
                type: 'choice',
                question: 'Access node found. Corporate vault wide open. Your move?',
                choices: [
                    { text: 'A) Copy and vanish', flavor: 'The silent shadow\'s move.', role: 'ghost', weight: 2 },
                    { text: 'B) Crack deeper', flavor: 'Hungry for more data.', role: 'venom', weight: 3 },
                    { text: 'C) Sell the access', flavor: 'Intel is currency.', role: 'prophet', weight: 2 }
                ]
            },
            {
                id: 2,
                type: 'choice',
                question: 'Detected during extraction. Alarms screaming. React:',
                choices: [
                    { text: 'A) Delete & run', flavor: 'Leave no trace.', role: 'ghost', weight: 3 },
                    { text: 'B) Upload false logs', flavor: 'Misdirection is an art.', role: 'venom', weight: 3 },
                    { text: 'C) Hold & dump everything', flavor: 'Never waste a breach.', role: 'prophet', weight: 2 }
                ]
            },
            {
                id: 3,
                type: 'puzzle',
                question: 'Vault sequence lock. Arrange the icons: mask ‚Üí spike ‚Üí eye',
                correctOrder: ['üé≠', '‚ö°', 'ÔøΩÔ∏è'],
                icons: ['‚ö°', 'ÔøΩÔ∏è', 'üé≠'], // Scrambled
                scores: { ghost: 2, venom: 1, prophet: 1 }
            },
            {
                id: 4,
                type: 'choice',
                question: 'Corporate raid intel intercepted. Neighborhood at risk. Your call?',
                choices: [
                    { text: 'A) Leak now', flavor: 'Anonymous guardian.', role: 'ghost', weight: 1 },
                    { text: 'B) Wait and leverage', flavor: 'Information has timing.', role: 'prophet', weight: 3 },
                    { text: 'C) Not your fight', flavor: 'Stay invisible, stay alive.', role: 'venom', weight: 2 }
                ]
            }
        ];

        // ========== STATE MANAGEMENT ==========
        let currentQuestionIndex = 0;
        let answers = JSON.parse(localStorage.getItem('neonserpents_initiation')) || [];
        let scores = { ghost: 0, venom: 0, prophet: 0 };

        // ========== DOM ELEMENTS ==========
        const questionCard = document.getElementById('questionCard');
        const submitBtn = document.getElementById('submitBtn');
        const skipBtn = document.getElementById('skipBtn');
        const abortBtn = document.getElementById('abortBtn');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const roleModal = document.getElementById('roleModal');
        const roleIcon = document.getElementById('roleIcon');
        const roleTitle = document.getElementById('roleTitle');
        const roleDescription = document.getElementById('roleDescription');
        const acceptRoleBtn = document.getElementById('acceptRoleBtn');
        const retryBtn = document.getElementById('retryBtn');

        // ========== ROLE DEFINITIONS ==========
        const roles = {
            ghost: {
                title: 'GHOST',
                icon: 'üëÅÔ∏è',
                description: 'You move through shadows unseen. The grid never knows you were there.'
            },
            venom: {
                title: 'VENOM',
                icon: 'üêç',
                description: 'You weaponize data like poison through veins. Networks bend, truth fractures, chaos follows.'
            },
            prophet: {
                title: 'PROPHET',
                icon: 'üîÆ',
                description: 'You see patterns others miss. Five moves ahead, always playing the long game.'
            }
        };

        // ========== RENDER QUESTION ==========
        function renderQuestion(index) {
            const question = questions[index];
            questionCard.innerHTML = '';

            // Add question number and text
            const questionTitle = document.createElement('h3');
            questionTitle.textContent = `Question ${index + 1}`;
            questionCard.appendChild(questionTitle);

            const questionText = document.createElement('p');
            questionText.className = 'question-text';
            questionText.textContent = question.question;
            questionCard.appendChild(questionText);

            // Render based on question type
            if (question.type === 'choice') {
                renderChoiceQuestion(question, index);
            } else if (question.type === 'puzzle') {
                renderPuzzleQuestion(question, index);
            }

            // Update progress
            updateProgress();

            // Trigger card flip animation
            const questionArea = document.getElementById('questionArea');
            questionArea.style.animation = 'none';
            setTimeout(() => {
                questionArea.style.animation = 'cardFlip 0.6s ease-out';
            }, 10);
        }

        // ========== RENDER CHOICE QUESTION ==========
        function renderChoiceQuestion(question, index) {
            const choicesDiv = document.createElement('div');
            choicesDiv.className = 'choices';
            choicesDiv.setAttribute('role', 'radiogroup');
            choicesDiv.setAttribute('aria-label', `Question ${index + 1} choices`);

            question.choices.forEach((choice, choiceIndex) => {
                const choiceWrapper = document.createElement('div');
                choiceWrapper.className = 'choice-wrapper';

                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice.text;
                btn.setAttribute('role', 'radio');
                btn.setAttribute('aria-checked', 'false');
                btn.setAttribute('tabindex', choiceIndex === 0 ? '0' : '-1');

                // Check if previously selected
                if (answers[index] === choiceIndex) {
                    btn.classList.add('selected');
                    btn.setAttribute('aria-checked', 'true');
                    submitBtn.disabled = false;
                }

                btn.onclick = () => selectChoice(choiceIndex, question.choices);
                
                // Keyboard navigation
                btn.addEventListener('keydown', (e) => {
                    const buttons = Array.from(choicesDiv.querySelectorAll('.choice-btn'));
                    const currentIndex = buttons.indexOf(btn);
                    
                    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const nextIndex = (currentIndex + 1) % buttons.length;
                        buttons[nextIndex].focus();
                        buttons.forEach((b, i) => b.setAttribute('tabindex', i === nextIndex ? '0' : '-1'));
                    } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const prevIndex = (currentIndex - 1 + buttons.length) % buttons.length;
                        buttons[prevIndex].focus();
                        buttons.forEach((b, i) => b.setAttribute('tabindex', i === prevIndex ? '0' : '-1'));
                    } else if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });

                choiceWrapper.appendChild(btn);

                // Add flavor text
                if (choice.flavor) {
                    const flavorText = document.createElement('p');
                    flavorText.className = 'flavor-text';
                    flavorText.textContent = choice.flavor;
                    choiceWrapper.appendChild(flavorText);
                }

                choicesDiv.appendChild(choiceWrapper);
            });

            questionCard.appendChild(choicesDiv);
        }

        // ========== RENDER PUZZLE QUESTION ==========
        function renderPuzzleQuestion(question, index) {
            const puzzleDiv = document.createElement('div');
            puzzleDiv.className = 'puzzle-area';
            puzzleDiv.id = 'puzzleArea';
            puzzleDiv.setAttribute('role', 'group');
            puzzleDiv.setAttribute('aria-label', 'Symbol sequence puzzle');

            // Use saved order or scrambled default
            let currentOrder = answers[index] || [...question.icons];

            currentOrder.forEach((icon, iconIndex) => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'puzzle-icon';
                iconDiv.textContent = icon;
                iconDiv.setAttribute('data-index', iconIndex);
                iconDiv.setAttribute('role', 'button');
                iconDiv.setAttribute('tabindex', '0');
                iconDiv.setAttribute('aria-label', `Symbol ${iconIndex + 1}: ${getIconName(icon)}. Click to cycle.`);
                
                iconDiv.onclick = () => cyclePuzzleIcon(iconIndex, currentOrder, question);
                
                // Keyboard support
                iconDiv.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        iconDiv.click();
                    }
                });
                
                puzzleDiv.appendChild(iconDiv);
            });

            questionCard.appendChild(puzzleDiv);

            const hint = document.createElement('p');
            hint.style.fontSize = '0.9rem';
            hint.style.color = '#999';
            hint.style.marginTop = '1rem';
            hint.textContent = 'Click icons to cycle through symbols. Find the correct sequence.';
            questionCard.appendChild(hint);

            // Check if already solved
            if (JSON.stringify(currentOrder) === JSON.stringify(question.correctOrder)) {
                submitBtn.disabled = false;
            }
        }

        // ========== GET ICON NAME (for accessibility) ==========
        function getIconName(icon) {
            const iconNames = {
                'üé≠': 'mask',
                '‚ö°': 'spike',
                'üëÅÔ∏è': 'eye'
            };
            return iconNames[icon] || 'symbol';
        }

        // ========== HANDLE CHOICE SELECTION ==========
        function selectChoice(choiceIndex, choices) {
            // Update UI
            document.querySelectorAll('.choice-btn').forEach((btn, idx) => {
                btn.classList.toggle('selected', idx === choiceIndex);
                btn.setAttribute('aria-checked', idx === choiceIndex);
            });

            // Save answer
            answers[currentQuestionIndex] = choiceIndex;
            localStorage.setItem('neonserpents_initiation', JSON.stringify(answers));

            // Enable submit
            submitBtn.disabled = false;
        }

        // ========== HANDLE PUZZLE ICON CYCLE ==========
        function cyclePuzzleIcon(clickedIndex, currentOrder, question) {
            const allIcons = question.correctOrder;
            const currentIcon = currentOrder[clickedIndex];
            const currentIconIndex = allIcons.indexOf(currentIcon);
            const nextIconIndex = (currentIconIndex + 1) % allIcons.length;
            
            currentOrder[clickedIndex] = allIcons[nextIconIndex];

            // Re-render puzzle
            answers[currentQuestionIndex] = [...currentOrder];
            localStorage.setItem('neonserpents_initiation', JSON.stringify(answers));

            renderQuestion(currentQuestionIndex);

            // Check if correct
            if (JSON.stringify(currentOrder) === JSON.stringify(question.correctOrder)) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // ========== UPDATE PROGRESS BAR ==========
        function updateProgress() {
            const answered = answers.filter(a => a !== undefined).length;
            const percentage = (answered / questions.length) * 100;
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${answered} / ${questions.length}`;
        }

        // ========== SUBMIT ANSWER ==========
        function submitAnswer() {
            const question = questions[currentQuestionIndex];
            const answer = answers[currentQuestionIndex];

            // Calculate score for this answer
            if (question.type === 'choice') {
                const choice = question.choices[answer];
                scores[choice.role] += choice.weight;
            } else if (question.type === 'puzzle') {
                // Puzzle correct = bonus to all roles (per spec)
                if (JSON.stringify(answer) === JSON.stringify(question.correctOrder)) {
                    scores.ghost += question.scores.ghost;
                    scores.venom += question.scores.venom;
                    scores.prophet += question.scores.prophet;
                }
            }

            // Move to next question or reveal role
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                submitBtn.disabled = true;
            } else {
                revealRole();
            }
        }

        // ========== SKIP QUESTION ==========
        function skipQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                submitBtn.disabled = true;
            } else {
                revealRole();
            }
        }

        // ========== ABORT TEST ==========
        function abortTest() {
            if (confirm('Are you sure you want to abort? All progress will be lost.')) {
                localStorage.removeItem('neonserpents_initiation');
                window.location.href = 'landing.html';
            }
        }

        // ========== REVEAL ROLE ==========
        function revealRole() {
            // Find highest scoring role
            let assignedRole = 'ghost'; // Default
            let maxScore = scores.ghost;

            if (scores.venom > maxScore) {
                assignedRole = 'venom';
                maxScore = scores.venom;
            }
            if (scores.prophet > maxScore) {
                assignedRole = 'prophet';
                maxScore = scores.prophet;
            }

            // If tie, prefer ghost > venom > prophet
            if (scores.ghost === scores.venom && scores.ghost === scores.prophet) {
                assignedRole = 'ghost';
            } else if (scores.ghost === scores.venom && scores.ghost > scores.prophet) {
                assignedRole = 'ghost';
            } else if (scores.venom === scores.prophet && scores.venom > scores.ghost) {
                assignedRole = 'venom';
            }

            const role = roles[assignedRole];

            // Store assigned role for next page
            localStorage.setItem('neonserpents_role', assignedRole);

            // Update modal
            roleIcon.textContent = role.icon;
            roleTitle.textContent = role.title;
            roleDescription.textContent = role.description;

            // Show processing screen first
            const processingScreen = document.getElementById('processingScreen');
            processingScreen.style.display = 'flex';

            // After 1.2 seconds, hide processing and show modal
            setTimeout(() => {
                processingScreen.style.display = 'none';
                roleModal.classList.add('active');
                trapFocus(roleModal);
                acceptRoleBtn.focus();
            }, 1200);
        }

        // ========== FOCUS TRAP FOR MODAL ==========
        function trapFocus(modal) {
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                }
                if (e.key === 'Escape') {
                    retryTest();
                }
            });
        }

        // ========== ACCEPT ROLE ==========
        function acceptRole() {
            localStorage.removeItem('neonserpents_initiation');
            // Redirect to role confirmation page
            window.location.href = 'role.html';
        }

        // ========== RETRY TEST ==========
        function retryTest() {
            localStorage.removeItem('neonserpents_initiation');
            window.location.reload();
        }

        // ========== EVENT LISTENERS ==========
        submitBtn.addEventListener('click', submitAnswer);
        skipBtn.addEventListener('click', skipQuestion);
        abortBtn.addEventListener('click', abortTest);
        acceptRoleBtn.addEventListener('click', acceptRole);
        retryBtn.addEventListener('click', retryTest);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !submitBtn.disabled) {
                submitAnswer();
            }
        });

        // ========== INITIALIZE ==========
        renderQuestion(currentQuestionIndex);
    </script>
</body>
</html>
